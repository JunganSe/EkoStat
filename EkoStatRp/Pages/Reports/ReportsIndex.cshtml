@page "/Reports"
@using EkoStatLibrary.Enums;
@model EkoStatRp.Pages.Reports.ReportsIndex
@inject EkoStatLibrary.Helpers.DtoHelper _dtoHelper
@{
    ViewData["Title"] = "Reports";
    var earliestTimestamp = new DateTime();
    var latestTimestamp = new DateTime();
    double days = 0;
    double weeks = 0;
    double months = 0;
    double years = 0;
    int entriesCount = Model.EntryGroups.Sum(eg => eg.Entries.Count);
    if (entriesCount > 0)
    {
        earliestTimestamp = Model.EntryGroups.SelectMany(eg => eg.Entries).Select(e => e.Timestamp).Min();
        latestTimestamp = Model.EntryGroups.SelectMany(eg => eg.Entries).Select(e => e.Timestamp).Max();
        var timeSpan = latestTimestamp - earliestTimestamp;
        days = timeSpan.TotalDays;
        weeks = Math.Round(days / 7, 2);
        months = Math.Round(days / 30.44, 2);
        years = Math.Round(days / 365.25, 2);
    }
    var totalCost = Model.EntryGroups.Sum(eg => eg.TotalCost);
}

<h1>Reports</h1>
<a asp-page="@Constants.RazorPages.ReportsSaved">Saved reports</a>

<form method="post">
    <hr />
    <h2>Filter</h2>
    <partial name="@Constants.PartialViews.FilterEntries" model="@Model.FilterViewModel" />

    <hr />
    <h2>Report settings</h2>
    <div class="flexRow">
        <div>
            <label asp-for="@Model.Report.CostLimit"></label>
            <input asp-for="@Model.Report.CostLimit" />
            <span asp-validation-for="@Model.Report.CostLimit" class="text-danger"></span>
        </div>
        <div>
            <label asp-for="@Model.Report.CostLimitType"></label>
            <select asp-for="@Model.Report.CostLimitType">
                @foreach (var costLimitType in Enum.GetValues(typeof(LimitType)))
                {
                    <option value="@costLimitType">@costLimitType</option>
                }
            </select>
            <span asp-validation-for="@Model.Report.CostLimitType" class="text-danger"></span>
        </div>
    </div>

    <button type="submit">Generate report</button>
</form>

@if (entriesCount > 0)
{
    <hr />
    <h2>Summary</h2>
    <p>
        Showing @Model.EntryGroups.Count articles from @entriesCount entries <br />
        from @earliestTimestamp until @latestTimestamp <br />
        which is @days days, or @weeks weeks, or about @months months, or about @years years <br />
        with a total cost of @totalCost
    </p>

    <hr />
    <h2>Articles</h2>
    <table class="table-bordered">
        <thead>
            <tr>
                <th>Article</th>
                <th>Count</th>
                <th>Total cost</th>
                <th>Tags</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var group in Model.EntryGroups)
            {
                var tags = _dtoHelper.GetTagNamesAsString(group.Article.Tags);
                <tr>
                    <td>@group.Article.Name</td>
                    <td>@group.TotalCount</td>
                    <td>@group.TotalCost</td>
                    <td>@tags</td>
                </tr>
            }
        </tbody>
    </table>
}
